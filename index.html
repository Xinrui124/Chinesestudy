<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我是语文小状元</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="mark">语</div>
      <div class="brandText">
        <h1>我是语文小状元</h1>
        <p class="sub">二年级 · 闯关练习 · 即时反馈 · 全班同榜</p>
      </div>
    </div>

    <nav class="nav">
      <button class="navBtn active" data-view="home">首页</button>
      <button class="navBtn" data-view="board">今日榜单</button>
      <button class="navBtn" data-view="teacher">教师设置</button>
    </nav>
  </header>

  <main class="container">
    <!-- 首页：姓名 + 板块 -->
    <section id="view-home" class="view">
      <div class="card hero">
        <div class="heroLeft">
          <h2>先输入姓名，再选一个板块开始闯关</h2>
          <p class="muted">答对 +1 分；做错要重做，直到正确才能进入下一题。</p>

          <div class="nameRow">
            <label class="label" for="studentName">学生姓名</label>
            <input id="studentName" class="input" placeholder="例如：小明" maxlength="12" />
            <button id="btnSaveName" class="btn primary">确认姓名</button>
          </div>

          <div class="miniStats">
            <div class="pill">当前姓名：<strong id="nameText">未填写</strong></div>
            <div class="pill">今日积分：<strong id="todayScoreText">0</strong></div>
          </div>

          <div class="muted tiny">
            全班同榜说明：需要教师先在“教师设置”里配置一个 Google 表格接口（5分钟搞定）。
          </div>
        </div>

        <div class="heroRight">
          <div class="flowers">
            <button class="flower f1" data-topic="字词" aria-label="字词">字词</button>
            <button class="flower f2" data-topic="句子" aria-label="句子">句子</button>
            <button class="flower f3" data-topic="古诗" aria-label="古诗">古诗</button>
            <button class="flower f4" data-topic="阅读" aria-label="阅读">阅读</button>
          </div>
          <p class="hint muted">提示：选择板块后，会进入“单元 → 课文 → 闯关”。</p>
        </div>
      </div>
    </section>

    <!-- 单元选择 -->
    <section id="view-unit" class="view hidden">
      <div class="card">
        <div class="row space">
          <div>
            <h2>选择单元</h2>
            <p class="muted">板块：<strong id="unitTopicText">—</strong>　|　姓名：<strong id="unitNameText">—</strong></p>
          </div>
          <button class="btn" id="btnBackHome1">返回首页</button>
        </div>
        <div class="unitGrid" id="unitGrid"></div>
      </div>
    </section>

    <!-- 课文选择 -->
    <section id="view-lesson" class="view hidden">
      <div class="card">
        <div class="row space">
          <div>
            <h2>选择课文</h2>
            <p class="muted">板块：<strong id="lessonTopicText">—</strong>　|　单元：<strong id="lessonUnitText">—</strong>　|　姓名：<strong id="lessonNameText">—</strong></p>
          </div>
          <div class="row gap">
            <button class="btn" id="btnBackUnit">返回单元</button>
            <button class="btn" id="btnBackHome2">返回首页</button>
          </div>
        </div>

        <div class="lessonGrid" id="lessonGrid"></div>
        <div class="muted tiny">
          说明：若课文显示“暂无题库”，你把题库发我即可继续补充。
        </div>
      </div>
    </section>

    <!-- 闯关页 -->
    <section id="view-game" class="view hidden">
      <div class="card">
        <div class="row space">
          <div class="leftMeta">
            <div class="badge">二年级</div>
            <div class="badge soft" id="topicBadge">板块：—</div>
            <div class="badge soft" id="unitBadge">单元：—</div>
            <div class="badge soft" id="lessonBadge">课文：—</div>
            <div class="badge soft">姓名：<span id="playerNameInGame">—</span></div>
          </div>
          <div class="rightMeta">
            <div class="scoreBox">本轮得分：<strong id="roundScore">0</strong></div>
            <div class="scoreBox">今日总分：<strong id="dayScore">0</strong></div>
          </div>
        </div>

        <div class="progress">
          <div class="bar" id="progressBar"></div>
        </div>

        <div class="qArea">
          <div class="qIndex" id="qIndex">第 1 题</div>
          <h2 class="qTitle" id="qTitle">加载中…</h2>
          <p class="qDesc muted" id="qDesc"></p>

          <div id="qBody"></div>

          <div class="feedback" id="feedback" aria-live="polite"></div>

          <div class="row space actions">
            <button class="btn" id="btnQuitToLesson">返回课文</button>
            <button class="btn primary" id="btnNext" disabled>下一题</button>
          </div>

          <div class="muted tiny">
            规则：做错必须重做；答对才解锁“下一题”。答对会自动提交到“全班同榜”（若已配置）。
          </div>
        </div>
      </div>
    </section>

    <!-- 今日榜单 -->
    <section id="view-board" class="view hidden">
      <div class="card">
        <div class="row space">
          <div>
            <h2>今日榜单 🏆</h2>
            <p class="muted">
              若教师已配置 Google 表格接口：这里显示“全班同榜”。否则退化为“本机榜单”。
            </p>
          </div>
          <div class="row gap">
            <button class="btn" id="btnRefreshBoard">刷新榜单</button>
            <button class="btn" id="btnClearLocal">清空本机榜单</button>
          </div>
        </div>

        <div class="boardGrid">
          <div class="boardCard">
            <div class="boardTitle">今天语文小状元</div>
            <div class="champ" id="champText">—</div>
            <div class="muted tiny" id="champSub">—</div>
          </div>

          <div class="boardCard">
            <div class="boardTitle">排行榜</div>
            <div id="boardList" class="boardList"></div>
          </div>
        </div>

        <div class="muted tiny" id="boardStatus">—</div>
      </div>
    </section>

    <!-- 教师设置 -->
    <section id="view-teacher" class="view hidden">
      <div class="card">
        <h2>教师设置：开启“全班同榜”（推荐：Google 表格，5分钟）</h2>

        <ol class="help">
          <li>打开 Google Drive → 新建一个表格（例如：<strong>语文小状元积分</strong>）。</li>
          <li>表格里随便留空即可，数据会自动写入。</li>
          <li>在表格里：扩展程序 → Apps Script，创建脚本，粘贴下方代码。</li>
          <li>部署 → 新建部署 → 类型选择“Web 应用”：
            <ul>
              <li>执行身份：我（脚本所有者）</li>
              <li>访问权限：任何人</li>
            </ul>
            得到一个 <strong>Web App URL</strong>。
          </li>
          <li>把 URL 粘贴到 <code>app.js</code> 里 <code>REMOTE_LEADERBOARD_URL</code> 变量即可。</li>
        </ol>

        <h3>Apps Script 代码（复制粘贴即可）</h3>
        <pre class="codeBlock"><code>function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("scores") || ss.insertSheet("scores");
  var data = JSON.parse(e.postData.contents || "{}");

  // data: { date:"YYYY-MM-DD", name:"小明", delta:1 }
  var date = data.date || "";
  var name = data.name || "";
  var delta = Number(data.delta || 0);

  if (!date || !name || !delta) {
    return ContentService.createTextOutput(JSON.stringify({ ok:false, error:"bad params" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // 表头
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["date", "name", "score"]);
  }

  // 查找同一天同名
  var values = sheet.getDataRange().getValues();
  var row = -1;
  for (var i = 1; i < values.length; i++) {
    if (values[i][0] === date && values[i][1] === name) {
      row = i + 1; // 1-based
      break;
    }
  }

  if (row === -1) {
    sheet.appendRow([date, name, delta]);
  } else {
    var current = Number(sheet.getRange(row, 3).getValue() || 0);
    sheet.getRange(row, 3).setValue(current + delta);
  }

  return ContentService.createTextOutput(JSON.stringify({ ok:true }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("scores");
  var date = (e.parameter && e.parameter.date) ? e.parameter.date : "";

  if (!sheet || !date) {
    return ContentService.createTextOutput(JSON.stringify({ ok:false, entries:[] }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  var values = sheet.getDataRange().getValues();
  var entries = [];
  for (var i = 1; i < values.length; i++) {
    if (values[i][0] === date) {
      entries.push({ name: values[i][1], score: Number(values[i][2] || 0) });
    }
  }
  entries.sort(function(a,b){ return b.score - a.score; });
  return ContentService.createTextOutput(JSON.stringify({ ok:true, entries:entries }))
    .setMimeType(ContentService.MimeType.JSON);
}</code></pre>

        <p class="muted tiny">
          配置好后，全班同学在不同设备上答题，榜单会自动汇总到同一个 Google 表格里。
        </p>
      </div>
    </section>

  </main>

  <footer class="footer muted">© 我是语文小状元 · 二年级语文闯关</footer>
  <script src="./app.js"></script>
</body>
</html>
